<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë¼ ëë§ì‡ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .game-mode {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .mode-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .mode-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .mode-btn.active {
            background: #764ba2;
        }
        .search-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
            max-height: 50vh;
            overflow-y: auto;
        }
        .search-overlay.show {
            display: block;
        }
        .search-panel {
            background: white;
            border-radius: 0 0 20px 20px;
            padding: 20px 30px 30px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            margin: 0 auto;
            animation: slideDown 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .search-header h2 {
            margin: 0;
            color: #333;
        }
        .close-btn {
            background: #ff6b6b;
            padding: 8px 16px;
            font-size: 14px;
        }
        .close-btn:hover {
            background: #ee5a5a;
        }
        .game-area {
            margin-bottom: 30px;
        }
        .game-layout {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 25px;
            margin-top: 20px;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }
        .left-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .right-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .stats-section {
            margin-bottom: 0;
        }
        .stats-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .stat-item:last-child {
            border-bottom: none;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .stat-value {
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }
        .win-rate {
            font-size: 28px;
            color: #667eea;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        .game-info-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #e0e0e0;
        }
        .game-info-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .info-item {
            padding: 8px 0;
            font-size: 14px;
            color: #666;
        }
        .info-item strong {
            color: #333;
            font-weight: bold;
        }
        .current-turn {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            color: #1976d2;
        }
        .center-panel {
            min-width: 0;
        }
        .turn-selection {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
        }
        .turn-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .turn-btn:hover {
            background: #667eea;
            color: white;
        }
        .turn-btn.selected {
            background: #667eea;
            color: white;
        }
        .turn-btn:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .turn-btn:disabled:hover {
            background: #ccc;
            color: #666;
            transform: none;
        }
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            border-top: 2px solid #667eea;
        }
        .input-container .input-group {
            max-width: 1600px;
            margin: 0 auto;
        }
        .center-panel {
            padding-bottom: 80px;
        }
        .hamburger-menu {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .hamburger-menu:hover {
            background: #5568d3;
        }
        .panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        .panel-overlay.show {
            display: block;
        }
        .mobile-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 280px;
            background: white;
            z-index: 999;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            display: block;
        }
        .mobile-panel.show {
            transform: translateX(0) !important;
            display: block !important;
        }
        .mobile-panel.left {
            left: 0;
        }
        .mobile-panel.right {
            right: 0;
            transform: translateX(100%);
        }
        .mobile-panel.right.show {
            transform: translateX(0) !important;
            display: block !important;
        }
        .panel-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .panel-toggle-btn {
            display: none;
            padding: 10px 15px;
            margin: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        @media (max-width: 1400px) {
            .game-layout {
                grid-template-columns: 280px 1fr 320px;
            }
        }
        @media (max-width: 1200px) {
            .game-layout {
                grid-template-columns: 250px 1fr 280px;
            }
        }
        @media (max-width: 900px) {
            .hamburger-menu {
                display: block;
            }
            .panel-toggle-btn {
                display: block;
            }
            .game-layout {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .left-panel,
            .right-panel {
                display: none;
            }
            .center-panel {
                padding-bottom: 80px;
            }
            .available-countries-list {
                max-height: 400px;
            }
            .input-container {
                padding: 12px 15px;
            }
            .input-container .input-group {
                flex-direction: column;
                gap: 10px;
            }
            .input-container button {
                width: 100%;
            }
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .history {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .history-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .history-item.user {
            background: #e3f2fd;
            text-align: right;
        }
        .history-item.computer {
            background: #fff3e0;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .message.success {
            background: #c8e6c9;
            color: #2e7d32;
        }
        .message.error {
            background: #ffcdd2;
            color: #c62828;
        }
        .message.info {
            background: #bbdefb;
            color: #1565c0;
        }
        .search-results {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .country-tag {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .available-countries-section {
            padding: 0;
            background: transparent;
            border: none;
        }
        .available-countries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .available-countries-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            width: 100%;
        }
        .available-countries-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .available-country-tag {
            background: #9e9e9e;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .available-country-tag:hover {
            background: #757575;
            transform: translateX(5px);
        }
        .available-country-tag.non-loop {
            background: #667eea;
            color: white;
        }
        .available-country-tag.non-loop:hover {
            background: #5568d3;
            transform: translateX(5px);
        }
        .depth-calculation-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border: 2px solid #667eea;
        }
        .depth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 10px;
            background: white;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .depth-header:hover {
            background: #f0f0f0;
        }
        .depth-header h3 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        .toggle-icon {
            font-size: 14px;
            color: #667eea;
            transition: transform 0.3s;
            display: inline-block;
        }
        .depth-header:hover .toggle-icon {
            color: #5568d3;
        }
        .depth-content {
            display: none;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: #333;
            background: white;
            padding: 15px;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .depth-content.show {
            display: block;
        }
        .depth-content .depth-item {
            margin-left: 20px;
            padding: 2px 0;
        }
        .depth-content .depth-item.win {
            color: #2e7d32;
            font-weight: bold;
        }
        .depth-content .depth-item.lose {
            color: #c62828;
        }
        .depth-content .depth-item.unknown {
            color: #666;
        }
        .depth-content .depth-item.selected {
            background: #fff3cd;
            padding: 5px;
            border-radius: 3px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ ë‚˜ë¼ ëë§ì‡ê¸°</h1>
        <button class="hamburger-menu" onclick="toggleLeftPanel()" id="hamburgerBtn">â˜°</button>
        <div class="game-mode">
            <button class="mode-btn active">ì»´í“¨í„°ì™€ í”Œë ˆì´</button>
            <button class="mode-btn" onclick="openSearch()">ğŸ” ë‚˜ë¼ ê²€ìƒ‰</button>
        </div>
        <div id="gameArea" class="game-area">
            <div id="turnSelection" class="turn-selection">
                <div style="margin-right: 20px; line-height: 40px; font-weight: bold;">ì„ ê³µ/í›„ê³µ ì„ íƒ:</div>
                <button class="turn-btn selected" onclick="selectTurn('user')" id="turnBtnUser">ë‚˜ ë¨¼ì € (ì„ ê³µ)</button>
                <button class="turn-btn" onclick="selectTurn('computer')" id="turnBtnComputer">ì»´í“¨í„° ë¨¼ì € (í›„ê³µ)</button>
            </div>
            <div id="message" class="message info">ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”! ê°€ëŠ¥í•œ ë‚˜ë¼ë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            <div class="game-layout">
                <div class="left-panel" id="leftPanel">
                    <div class="stats-section">
                        <h3>ğŸ“Š ìŠ¹ë¥  í†µê³„</h3>
                        <div class="win-rate" id="winRate">0%</div>
                        <div class="stat-item">
                            <span class="stat-label">ìŠ¹ë¦¬</span>
                            <span class="stat-value" id="wins">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">íŒ¨ë°°</span>
                            <span class="stat-value" id="losses">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ì´ ê²Œì„</span>
                            <span class="stat-value" id="totalGames">0</span>
                        </div>
                    </div>
                    <div class="game-info-section">
                        <h3>ğŸ® í˜„ì¬ ê²Œì„</h3>
                        <div class="info-item">
                            <strong>ì‚¬ìš©ëœ ë‚˜ë¼:</strong> <span id="usedCount">0</span>ê°œ
                        </div>
                        <div class="info-item">
                            <strong>ë§ˆì§€ë§‰ ë‚˜ë¼:</strong> <span id="lastCountryDisplay">-</span>
                        </div>
                        <div class="info-item">
                            <strong>ë‹¤ìŒ ì´ˆì„±:</strong> <span id="nextInitialDisplay">-</span>
                        </div>
                        <div class="current-turn" id="currentTurnDisplay">
                            í˜„ì¬ ì°¨ë¡€: ë‚˜
                        </div>
                    </div>
                </div>
                <div class="center-panel">
                    <div class="controls">
                        <button onclick="startNewGame()">ìƒˆ ê²Œì„</button>
                        <button onclick="undoMove()" id="undoBtn">ë¬´ë¥´ê¸°</button>
                        <button onclick="surrender()" id="surrenderBtn" style="background-color: #dc3545;">ê¸°ê¶Œ</button>
                        <button onclick="exportGameHistory()" id="exportBtn">ê¸°ë¡ ì €ì¥</button>
                    </div>
                    <div class="history" id="history"></div>
                    <div class="depth-calculation-section" id="depthCalculationSection" style="display: none;">
                        <div class="depth-header" onclick="toggleDepthCalculation()">
                            <h3>ğŸ” ì»´í“¨í„° ìˆ˜ ì½ê¸° ë¶„ì„</h3>
                            <span class="toggle-icon" id="depthToggleIcon">â–¼</span>
                        </div>
                        <div class="depth-content" id="depthContent"></div>
                    </div>
                </div>
                <div class="right-panel" id="rightPanel">
                    <div class="available-countries-section" id="availableCountriesSection">
                        <div class="available-countries-header">
                            <h3>ğŸ“‹ ë‹¤ìŒì— ê°€ëŠ¥í•œ ë‚˜ë¼ë“¤</h3>
                        </div>
                        <div class="info-item" style="margin-bottom: 10px; font-size: 13px; color: #666;">
                            ì´ <strong id="availableCount">0</strong>ê°œ ê°€ëŠ¥
                        </div>
                        <div class="available-countries-list" id="availableCountriesList"></div>
                    </div>
                    <div class="game-info-section">
                        <h3>ğŸ’¡ ê²Œì„ íŒ</h3>
                        <div class="info-item" style="font-size: 13px; line-height: 1.6;">
                            <strong>ğŸ”„ ëºê¸° ì‹œìŠ¤í…œ:</strong><br>
                            í›„ê³µë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ì„ ê³µì´ ì²« ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ë©´, ê·¸ ë‹¨ì–´ê°€ ìŠ¹ë¦¬í•  ê°€ëŠ¥ì„±ì´ ë†’ì„ ë•Œ "ëºê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ê·¸ ë‹¨ì–´ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ë©´ ì°¨ë¡€ê°€ ë°”ë€ë‹ˆë‹¤. ì´ì œ ë‹¹ì‹ ì´ ì„ ê³µì´ ë©ë‹ˆë‹¤!<br><br>
                            <strong>ì „ëµ íŒ:</strong>
                            â€¢ ã„·~ã„±ì´ í•˜ë‚˜ ë¹ ì§€ë©´ ã„·ì´ ì´ê¹ë‹ˆë‹¤.<br>
                            â€¢ ã„¹~ã…‡ì´ í•˜ë‚˜ ë¹ ì§€ë©´ ã„¹ì´ ì´ê¹ë‹ˆë‹¤.<br>
                            â€¢ ã…‡ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‚˜ë¼ê°€ ê°€ì¥ ë§ìœ¼ë©°, ê³µê²©ì´ ê°€ì¥ ë§ìŠµë‹ˆë‹¤!
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-overlay" id="panelOverlay" onclick="closeAllPanels()"></div>
        <div class="mobile-panel left" id="mobileLeftPanel">
            <button class="panel-close" onclick="closeLeftPanel()">Ã—</button>
            <div class="left-panel" style="position: static; padding: 20px;">
                <div class="stats-section">
                    <h3>ğŸ“Š ìŠ¹ë¥  í†µê³„</h3>
                    <div class="win-rate" id="winRateMobile">0%</div>
                    <div class="stat-item">
                        <span class="stat-label">ìŠ¹ë¦¬</span>
                        <span class="stat-value" id="winsMobile">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">íŒ¨ë°°</span>
                        <span class="stat-value" id="lossesMobile">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ì´ ê²Œì„</span>
                        <span class="stat-value" id="totalGamesMobile">0</span>
                    </div>
                </div>
                <div class="game-info-section">
                    <h3>ğŸ® í˜„ì¬ ê²Œì„</h3>
                    <div class="info-item">
                        <strong>ì‚¬ìš©ëœ ë‚˜ë¼:</strong> <span id="usedCountMobile">0</span>ê°œ
                    </div>
                    <div class="info-item">
                        <strong>ë§ˆì§€ë§‰ ë‚˜ë¼:</strong> <span id="lastCountryDisplayMobile">-</span>
                    </div>
                    <div class="info-item">
                        <strong>ë‹¤ìŒ ì´ˆì„±:</strong> <span id="nextInitialDisplayMobile">-</span>
                    </div>
                    <div class="current-turn" id="currentTurnDisplayMobile">
                        í˜„ì¬ ì°¨ë¡€: ë‚˜
                    </div>
                </div>
            </div>
        </div>
        <div class="mobile-panel right" id="mobileRightPanel">
            <button class="panel-close" onclick="closeRightPanel()">Ã—</button>
            <div class="right-panel" style="position: static; padding: 20px;">
                <div class="available-countries-section" id="availableCountriesSectionMobile">
                    <div class="available-countries-header">
                        <h3>ğŸ“‹ ë‹¤ìŒì— ê°€ëŠ¥í•œ ë‚˜ë¼ë“¤</h3>
                    </div>
                    <div class="info-item" style="margin-bottom: 10px; font-size: 13px; color: #666;">
                        ì´ <strong id="availableCountMobile">0</strong>ê°œ ê°€ëŠ¥
                    </div>
                    <div class="available-countries-list" id="availableCountriesListMobile"></div>
                </div>
                <div class="game-info-section">
                    <h3>ğŸ’¡ ê²Œì„ íŒ</h3>
                    <div class="info-item" style="font-size: 13px; line-height: 1.6;">
                        <strong>ğŸ”„ ëºê¸° ì‹œìŠ¤í…œ:</strong><br>
                        í›„ê³µë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. ì„ ê³µì´ ì²« ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ë©´, ê·¸ ë‹¨ì–´ê°€ ìŠ¹ë¦¬í•  ê°€ëŠ¥ì„±ì´ ë†’ì„ ë•Œ "ëºê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ê·¸ ë‹¨ì–´ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ë©´ ì°¨ë¡€ê°€ ë°”ë€ë‹ˆë‹¤. ì´ì œ ë‹¹ì‹ ì´ ì„ ê³µì´ ë©ë‹ˆë‹¤!<br><br>
                        <strong>ì „ëµ íŒ:</strong>
                        â€¢ ã„·~ã„±ì´ í•˜ë‚˜ ë¹ ì§€ë©´ ã„·ì´ ì´ê¹ë‹ˆë‹¤.<br>
                        â€¢ ã„¹~ã…‡ì´ í•˜ë‚˜ ë¹ ì§€ë©´ ã„¹ì´ ì´ê¹ë‹ˆë‹¤.<br>
                        â€¢ ã…‡ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‚˜ë¼ê°€ ê°€ì¥ ë§ìœ¼ë©°, ê³µê²©ì´ ê°€ì¥ ë§ìŠµë‹ˆë‹¤!
                    </div>
                </div>
            </div>
        </div>
        <div class="input-container">
            <div class="input-group">
                <div style="display: flex; gap: 10px; width: 100%; justify-content: center;">
                    <button class="panel-toggle-btn" onclick="toggleLeftPanel()">ğŸ“Š í†µê³„</button>
                    <button class="panel-toggle-btn" onclick="toggleRightPanel()">ğŸ“‹ ë‚˜ë¼</button>
                </div>
            </div>
        </div>
        <div id="searchOverlay" class="search-overlay" onclick="closeSearch(event)">
            <div class="search-panel" onclick="event.stopPropagation()">
                <div class="search-header">
                    <h2>ğŸ” ë‚˜ë¼ ê²€ìƒ‰</h2>
                    <button class="close-btn" onclick="closeSearch()">ë‹«ê¸°</button>
                </div>
                <div class="input-group">
                    <input type="text" id="searchInput" placeholder="ììŒì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ã„±, ã„´, ã„·...)" maxlength="1" onkeyup="searchCountries()" autofocus>
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
    </div>
    <script>
        const COUNTRY_NAMES = [
            "ê°€ë‚˜", "ê°€ë´‰", "ê°€ì´ì•„ë‚˜", "ê°ë¹„ì•„", "ê³¼í…Œë§ë¼", "ê·¸ë ˆë‚˜ë‹¤", "ê·¸ë¦¬ìŠ¤", "ê¸°ë‹ˆ", "ê¸°ë‹ˆë¹„ì‚¬ìš°",
            "ë‚˜ë¯¸ë¹„ì•„", "ë‚˜ìš°ë£¨", "ë‚˜ì´ì§€ë¦¬ì•„", "ë‚¨ìˆ˜ë‹¨", "ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­", "ë„¤ëœë€ë“œ", "ë„¤íŒ”", "ë…¸ë¥´ì›¨ì´", "ë‰´ì§ˆëœë“œ", "ë‹ˆì œë¥´", "ë‹ˆì¹´ë¼ê³¼",
            "ëŒ€ë§Œ", "ëŒ€í•œë¯¼êµ­", "ë´ë§ˆí¬", "ë„ë¯¸ë‹ˆì¹´ì—°ë°©", "ë„ë¯¸ë‹ˆì¹´ê³µí™”êµ­", "ë…ì¼", "ë™í‹°ëª¨ë¥´",
            "ë¼ì˜¤ìŠ¤", "ë¼ì´ë² ë¦¬ì•„", "ë¼íŠ¸ë¹„ì•„", "ëŸ¬ì‹œì•„", "ë ˆë°”ë…¼", "ë ˆì†Œí† ", "ë£¨ë§ˆë‹ˆì•„", "ë£©ì…ˆë¶€ë¥´í¬", "ë¥´ì™„ë‹¤", "ë¦¬ë¹„ì•„", "ë¦¬íˆ¬ì•„ë‹ˆì•„", "ë¦¬íˆí…ìŠˆíƒ€ì¸",
            "ë§ˆë‹¤ê°€ìŠ¤ì¹´ë¥´", "ë§ˆì…œì œë„", "ë§ˆì¼€ë„ë‹ˆì•„", "ë§ë¼ìœ„", "ë§ë ˆì´ì‹œì•„", "ë§ë¦¬", "ë©•ì‹œì½”", "ëª¨ë‚˜ì½”", "ëª¨ë¡œì½”", "ëª¨ë¦¬ì…”ìŠ¤", "ëª¨ë¦¬íƒ€ë‹ˆ", "ëª¨ì ë¹„í¬", "ëª¬í…Œë„¤ê·¸ë¡œ", "ëª°ë„ë°”", "ëª°ë””ë¸Œ", "ëª°íƒ€", "ëª½ê³¨", "ë¯¸êµ­", "ë¯¸ì–€ë§ˆ", "ë¯¸í¬ë¡œë„¤ì‹œì•„",
            "ë°”ëˆ„ì•„íˆ¬", "ë°”ë ˆì¸", "ë°”ë² ì´ë„ìŠ¤", "ë°”í•˜ë§ˆ", "ë°”í‹°ì¹¸", "ë°©ê¸€ë¼ë°ì‹œ", "ë² ëƒ‰", "ë² ë„¤ìˆ˜ì—˜ë¼", "ë² íŠ¸ë‚¨", "ë²¨ê¸°ì—", "ë²¨ë¼ë£¨ìŠ¤", "ë²¨ë¦¬ì¦ˆ", "ë³´ìŠ¤ë‹ˆì•„í—¤ë¥´ì²´ê³ ë¹„ë‚˜", "ë³´ì¸ ì™€ë‚˜", "ë³¼ë¦¬ë¹„ì•„", "ë¶€ë£¬ë””", "ë¶€ë¥´í‚¤ë‚˜íŒŒì†Œ", "ë¶€íƒ„", "ë¶ˆê°€ë¦¬ì•„", "ë¸Œë¼ì§ˆ", "ë¸Œë£¨ë‚˜ì´",
            "ì‚¬ëª¨ì•„", "ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„", "ì‚°ë§ˆë¦¬ë…¸", "ìƒíˆ¬ë©”í”„ë¦°ì‹œí˜", "ì„¸ë„¤ê°ˆ", "ì„¸ë¥´ë¹„ì•„", "ì„¸ì´ì…¸", "ì„¸ì¸íŠ¸í‚¤ì¸ ë„¤ë¹„ìŠ¤", "ì„¸ì¸íŠ¸ë£¨ì‹œì•„", "ì„¸ì¸íŠ¸ë¹ˆì„¼íŠ¸ê·¸ë ˆë‚˜ë”˜", "ì†Œë§ë¦¬ì•„", "ì†”ë¡œëª¬ì œë„", "ìˆ˜ë‹¨", "ìˆ˜ë¦¬ë‚¨", "ìŠ¤ë¦¬ë‘ì¹´", "ìŠ¤ì™€ì§ˆë€ë“œ", "ìŠ¤ì›¨ë´", "ìŠ¤ìœ„ìŠ¤", "ìŠ¤í˜ì¸", "ìŠ¬ë¡œë°”í‚¤ì•„", "ìŠ¬ë¡œë² ë‹ˆì•„", "ì‹œë¦¬ì•„", "ì‹œì—ë¼ë¦¬ì˜¨", "ì‹±ê°€í¬ë¥´",
            "ì•„ëì—ë¯¸ë¦¬íŠ¸", "ì•„ë¥´ë©”ë‹ˆì•„", "ì•„ë¥´í—¨í‹°ë‚˜", "ì•„ì´ìŠ¬ë€ë“œ", "ì•„ì´í‹°", "ì•„ì¼ëœë“œ", "ì•„ì œë¥´ë°”ì´ì”", "ì•„í”„ê°€ë‹ˆìŠ¤íƒ„", "ì•ˆë„ë¼", "ì•Œë°”ë‹ˆì•„", "ì•Œì œë¦¬", "ì•™ê³¨ë¼", "ì•¤í‹°ê°€ë°”ë¶€ë‹¤", "ì—ë¦¬íŠ¸ë ˆì•„", "ì—ìŠ¤ì™€í‹°ë‹ˆ", "ì—ìŠ¤í† ë‹ˆì•„", "ì—ì½°ë„ë¥´", "ì—í‹°ì˜¤í”¼ì•„", "ì—˜ì‚´ë°”ë„ë¥´", "ì˜êµ­", "ì˜ˆë©˜", "ì˜¤ë§Œ", "ì˜¤ìŠ¤íŠ¸ë¦¬ì•„", "ì˜¨ë‘ë¼ìŠ¤", "ìš”ë¥´ë‹¨", "ìš°ê°„ë‹¤", "ìš°ë£¨ê³¼ì´", "ìš°ì¦ˆë² í‚¤ìŠ¤íƒ„", "ìš°í¬ë¼ì´ë‚˜", "ì´ë¼í¬", "ì´ë€", "ì´ìŠ¤ë¼ì—˜", "ì´ì§‘íŠ¸", "ì´íƒˆë¦¬ì•„", "ì¸ë„", "ì¸ë„ë„¤ì‹œì•„", "ì¼ë³¸",
            "ìë©”ì´ì¹´", "ì ë¹„ì•„", "ì ë„ê¸°ë‹ˆ", "ì¡°ì§€ì•„", "ì¤‘ì•™ì•„í”„ë¦¬ì¹´ê³µí™”êµ­", "ì¤‘êµ­", "ì§€ë¶€í‹°", "ì§ë°”ë¸Œì›¨",
            "ì°¨ë“œ", "ì²´ì½”", "ì¹ ë ˆ",
            "ì¹´ë©”ë£¬", "ì¹´ë³´ë² ë¥´ë°", "ì¹´ìíìŠ¤íƒ„", "ì¹´íƒ€ë¥´", "ìº„ë³´ë””ì•„", "ìºë‚˜ë‹¤", "ì¼€ëƒ", "ì½”ëª¨ë¡œ", "ì½”ìŠ¤íƒ€ë¦¬ì¹´", "ì½”íŠ¸ë””ë¶€ì•„ë¥´", "ì½œë¡¬ë¹„ì•„", "ì½©ê³ ê³µí™”êµ­", "ì½©ê³ ë¯¼ì£¼ê³µí™”êµ­", "ì¿ ë°”", "ì¿ ì›¨ì´íŠ¸", "í¬ë¡œì•„í‹°ì•„", "í‚¤ë¥´ê¸°ìŠ¤ìŠ¤íƒ„", "í‚¤ë¦¬ë°”ì‹œ", "í‚¤í”„ë¡œìŠ¤",
            "íƒœêµ­", "íƒ€ì§€í‚¤ìŠ¤íƒ„", "íƒ„ìë‹ˆì•„", "í„°í‚¤", "í† ê³ ", "í†µê°€", "íˆ¬ë¥´í¬ë©”ë‹ˆìŠ¤íƒ„", "íˆ¬ë°œë£¨", "íŠ€ë‹ˆì§€", "íŠ¸ë¦¬ë‹ˆë‹¤ë“œí† ë°”ê³ ",
            "íŒŒë‚˜ë§ˆ", "íŒŒë¼ê³¼ì´", "íŒŒí‚¤ìŠ¤íƒ„", "íŒŒí‘¸ì•„ë‰´ê¸°ë‹ˆ", "íŒ”ë¼ìš°", "íŒ”ë ˆìŠ¤íƒ€ì¸", "í˜ë£¨", "í¬ë¥´íˆ¬ê°ˆ", "í´ë€ë“œ", "í”„ë‘ìŠ¤", "í”¼ì§€", "í•€ë€ë“œ", "í•„ë¦¬í•€",
            "í—ê°€ë¦¬", "í˜¸ì£¼"
        ];
        
        function getChosung(char) {
            const code = char.charCodeAt(0) - 0xAC00;
            if (code < 0 || code > 11171) return null;
            return Math.floor(code / 588);
        }
        
        function findCycles() {
            const cycles = [];
            const processed = new Set();
            
            for (let i = 0; i < COUNTRY_NAMES.length; i++) {
                for (let j = i + 1; j < COUNTRY_NAMES.length; j++) {
                    const a = COUNTRY_NAMES[i];
                    const b = COUNTRY_NAMES[j];
                    
                    if (processed.has(a) || processed.has(b)) continue;
                    
                    const aFirst = getChosung(a[0]);
                    const aLast = getChosung(a[a.length - 1]);
                    const bFirst = getChosung(b[0]);
                    const bLast = getChosung(b[b.length - 1]);
                    
                    if (aFirst === bLast && bFirst === aLast) {
                        cycles.push([a, b]);
                        processed.add(a);
                        processed.add(b);
                    }
                }
            }
            
            return cycles;
        }
        
        const LOOP_COUNTRIES = new Set(findCycles().flat());
        function getFirstCharInitial(text) {
            if (!text || text.length === 0) return null;
            const firstChar = text[0];
            const charCode = firstChar.charCodeAt(0);
            if (charCode >= 0xAC00 && charCode <= 0xD7A3) {
                const initialIndex = Math.floor((charCode - 0xAC00) / 588);
                const initials = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
                return initials[initialIndex];
            }
            return null;
        }
        function getLastCharInitial(countryName) {
            const lastChar = countryName[countryName.length - 1];
            const charCode = lastChar.charCodeAt(0);
            if (charCode >= 0xAC00 && charCode <= 0xD7A3) {
                const initialIndex = Math.floor((charCode - 0xAC00) / 588);
                const initials = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
                return initials[initialIndex];
            }
            return null;
        }
        function findCountry(name) {
            return COUNTRY_NAMES.find(c => c === name);
        }
        function findCountriesByInitial(initial) {
            return COUNTRY_NAMES.filter(c => getFirstCharInitial(c) === initial);
        }
        function getAvailableCountries(usedCountries, lastCountry) {
            if (!lastCountry) {
                return COUNTRY_NAMES.filter(c => !usedCountries.includes(c));
            }
            const last = findCountry(lastCountry);
            if (!last) return [];
            const nextInitial = getLastCharInitial(last);
            if (!nextInitial) return [];
            return COUNTRY_NAMES.filter(c => 
                getFirstCharInitial(c) === nextInitial && !usedCountries.includes(c)
            );
        }
        const gameState = {
            usedCountries: [],
            lastCountry: null,
            gameMode: 'vsComputer',
            difficulty: 'normal',
            gameEnded: false,
            firstPlayer: 'user', 
            currentPlayer: 'user', 
            firstTurnDone: false, 
            firstTurnCountry: null 
        };
        const gameHistory = [];
        let depthCalculationLog = [];
        let depthCalculationExpanded = false;
        
        function addDepthLog(message, type = 'info', depth = 0) {
            depthCalculationLog.push({ message, type, depth });
        }
        
        function clearDepthLog() {
            depthCalculationLog = [];
            updateDepthDisplay();
        }
        
        function updateDepthDisplay() {
            const contentEl = document.getElementById('depthContent');
            const sectionEl = document.getElementById('depthCalculationSection');
            
            if (depthCalculationLog.length === 0) {
                sectionEl.style.display = 'none';
                return;
            }
            
            sectionEl.style.display = 'block';
            let html = '';
            depthCalculationLog.forEach(log => {
                const indent = '  '.repeat(log.depth);
                const className = log.type === 'win' ? 'win' : log.type === 'lose' ? 'lose' : log.type === 'selected' ? 'selected' : '';
                html += `<div class="depth-item ${className}">${indent}${log.message}</div>`;
            });
            contentEl.innerHTML = html;
            
            if (depthCalculationExpanded) {
                contentEl.classList.add('show');
            } else {
                contentEl.classList.remove('show');
            }
        }
        
        function toggleDepthCalculation() {
            depthCalculationExpanded = !depthCalculationExpanded;
            const contentEl = document.getElementById('depthContent');
            const iconEl = document.getElementById('depthToggleIcon');
            
            if (depthCalculationExpanded) {
                contentEl.classList.add('show');
                iconEl.textContent = 'â–²';
            } else {
                contentEl.classList.remove('show');
                iconEl.textContent = 'â–¼';
            }
        }
        function getStats() {
            const stats = localStorage.getItem('countryGameStats');
            if (stats) {
                return JSON.parse(stats);
            }
            return { wins: 0, losses: 0, totalGames: 0 };
        }
        function saveStats(stats) {
            localStorage.setItem('countryGameStats', JSON.stringify(stats));
        }
        function saveGameState() {
            const stateToSave = {
                usedCountries: gameState.usedCountries,
                lastCountry: gameState.lastCountry,
                gameMode: gameState.gameMode,
                difficulty: gameState.difficulty,
                gameEnded: gameState.gameEnded,
                firstPlayer: gameState.firstPlayer,
                currentPlayer: gameState.currentPlayer,
                firstTurnDone: gameState.firstTurnDone,
                firstTurnCountry: gameState.firstTurnCountry,
                gameHistory: gameHistory
            };
            localStorage.setItem('countryGameState', JSON.stringify(stateToSave));
        }
        function loadGameState() {
            const savedState = localStorage.getItem('countryGameState');
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.gameEnded) {
                        return false;
                    }
                    if (state.usedCountries && state.usedCountries.length > 0) {
                        gameState.usedCountries = state.usedCountries;
                        gameState.lastCountry = state.lastCountry;
                        gameState.gameMode = state.gameMode || 'vsComputer';
                        gameState.difficulty = 'hell';
                        gameState.gameEnded = state.gameEnded || false;
                        gameState.firstPlayer = state.firstPlayer || 'user';
                        gameState.currentPlayer = state.currentPlayer || 'user';
                        gameState.firstTurnDone = state.firstTurnDone || false;
                        gameState.firstTurnCountry = state.firstTurnCountry || null;
                        if (state.gameHistory && state.gameHistory.length > 0) {
                            gameHistory.length = 0;
                            gameHistory.push(...state.gameHistory);
                        }
                        return true;
                    }
                } catch (e) {
                    console.error('ê²Œì„ ìƒíƒœ ë³µì› ì‹¤íŒ¨:', e);
                }
            }
            return false;
        }
        function clearGameState() {
            localStorage.removeItem('countryGameState');
        }
        function calculateWinProbability(country, usedCountries) {
            const nextAvailable = getAvailableCountries([...usedCountries, country], country);
            if (nextAvailable.length === 0) {
                return 100;
            }
            const grenadaUsed = usedCountries.includes('ê·¸ë ˆë‚˜ë‹¤');
            const dToGCount = usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„·' && last === 'ã„±';
            }).length;
            const isDWinSituation = dToGCount === 1 && !grenadaUsed;
            if (isDWinSituation) {
                const lastInitial = getLastCharInitial(country);
                if (lastInitial === 'ã„·') {
                    return 95;
                }
            }
            const allEndWithDOrR = nextAvailable.every(c => {
                const lastInitial = getLastCharInitial(c);
                return lastInitial === 'ã„·' || lastInitial === 'ã„¹';
            });
            if (allEndWithDOrR && nextAvailable.length > 0) {
                return 10;
            }
            const safeEndings = ['ã„±', 'ã„¹', 'ã…‚', 'ã…ˆ', 'ã…‹', 'ã…Œ'];
            const safeEndingCount = nextAvailable.filter(c => {
                const lastInitial = getLastCharInitial(c);
                return safeEndings.includes(lastInitial);
            }).length;
            const totalCount = nextAvailable.length;
            if (totalCount === 0) {
                return 100;
            }
            const safeRatio = safeEndingCount / totalCount;
            const baseProbability = 50;
            const probability = Math.round(baseProbability + (safeRatio - 0.5) * 40);
            return Math.max(10, Math.min(90, probability));
        }
        function calculateDepth(usedCountries, lastCountry, isComputerTurn, depth, maxDepth, nonLoopAvailableCache) {
            const indent = '  '.repeat(depth - 1);
            const turn = isComputerTurn ? 'ì»´í“¨í„°' : 'í”Œë ˆì´ì–´';
            console.log(`${indent}[Depth ${depth}] ${turn} ì°¨ë¡€ - ë§ˆì§€ë§‰ ë‚˜ë¼: ${lastCountry || 'ì—†ìŒ'}`);
            
            if (depth > maxDepth) {
                console.log(`${indent}  â†’ maxDepth ì´ˆê³¼, unknown ë°˜í™˜`);
                return 'unknown';
            }
            const available = getAvailableCountries(usedCountries, lastCountry);
            const nonLoopAvailable = nonLoopAvailableCache || available.filter(c => !isLoopCountry(c, available));
            console.log(`${indent}  ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¨ì–´: ${available.length}ê°œ, ëŒë¦¼ë‹¨ì–´ ì œì™¸: ${nonLoopAvailable.length}ê°œ`);
            
            if (nonLoopAvailable.length === 0) {
                const winner = isComputerTurn ? 'í”Œë ˆì´ì–´' : 'ì»´í“¨í„°';
                console.log(`${indent}  â†’ ëŒë¦¼ë‹¨ì–´ ì œì™¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¨ì–´ ì—†ìŒ, ìŠ¹ì: ${winner}`);
                if (isComputerTurn) {
                    return 'player';
                } else {
                    return 'computer';
                }
            }
            
            const dToGCount = usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„·' && last === 'ã„±';
            }).length;
            const gToDCount = usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„±' && last === 'ã„·';
            }).length;
            const dToGStrategy = dToGCount - gToDCount > 0;
            
            const rToYCount = usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„¹' && last === 'ã…‡';
            }).length;
            const yToRCount = usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã…‡' && last === 'ã„¹';
            }).length;
            const rToYStrategy = rToYCount - yToRCount > 0;
            
            if (dToGStrategy) {
                const safeEndings = ['ã„±', 'ã„·', 'ã„¹', 'ã…‚', 'ã…ˆ', 'ã…‹', 'ã…Œ'];
                const safeEndingAvailable = nonLoopAvailable.filter(c => {
                    const lastInitial = getLastCharInitial(c);
                    return safeEndings.includes(lastInitial);
                });
                if (safeEndingAvailable.length === 0) {
                    const winner = isComputerTurn ? 'í”Œë ˆì´ì–´' : 'ì»´í“¨í„°';
                    const msg = `â†’ ã„·~ã„± ì „ëµ: ì•ˆì „í•œ ì¢…ì„± ë‹¨ì–´ ì—†ìŒ, ìŠ¹ì: ${winner}`;
                    console.log(`${indent}  ${msg}`);
                    addDepthLog(msg, isComputerTurn ? 'lose' : 'win', depth - 1);
                    if (isComputerTurn) {
                        return 'player';
                    } else {
                        return 'computer';
                    }
                }
                const unsafeFirstInitials = new Set();
                nonLoopAvailable.forEach(c => {
                    const lastInitial = getLastCharInitial(c);
                    if (!safeEndings.includes(lastInitial)) {
                        unsafeFirstInitials.add(getFirstCharInitial(c));
                    }
                });
                const winningCountries = nonLoopAvailable.filter(c => {
                    const lastInitial = getLastCharInitial(c);
                    return unsafeFirstInitials.has(lastInitial);
                });
                if (winningCountries.length > 0) {
                    const msg = `â†’ ã„·~ã„± ì „ëµ: ìŠ¹ë¦¬ ë‹¨ì–´ ë°œê²¬ (${winningCountries.length}ê°œ)`;
                    console.log(`${indent}  ${msg}`);
                    addDepthLog(msg, isComputerTurn ? 'win' : 'lose', depth - 1);
                    if (isComputerTurn) {
                        return 'computer';
                    } else {
                        return 'player';
                    }
                }
            }
            
            if (rToYStrategy) {
                const safeEndings = ['ã„·', 'ã„¹'];
                const safeEndingAvailable = nonLoopAvailable.filter(c => {
                    const lastInitial = getLastCharInitial(c);
                    return safeEndings.includes(lastInitial);
                });
                if (safeEndingAvailable.length === 0) {
                    const winner = isComputerTurn ? 'í”Œë ˆì´ì–´' : 'ì»´í“¨í„°';
                    const msg = `â†’ ã„¹~ã…‡ ì „ëµ: ì•ˆì „í•œ ì¢…ì„± ë‹¨ì–´ ì—†ìŒ, ìŠ¹ì: ${winner}`;
                    console.log(`${indent}  ${msg}`);
                    addDepthLog(msg, isComputerTurn ? 'lose' : 'win', depth - 1);
                    if (isComputerTurn) {
                        return 'player';
                    } else {
                        return 'computer';
                    }
                }
                const unsafeFirstInitials = new Set();
                nonLoopAvailable.forEach(c => {
                    const lastInitial = getLastCharInitial(c);
                    if (!safeEndings.includes(lastInitial)) {
                        unsafeFirstInitials.add(getFirstCharInitial(c));
                    }
                });
                const winningCountries = nonLoopAvailable.filter(c => {
                    const lastInitial = getLastCharInitial(c);
                    return unsafeFirstInitials.has(lastInitial);
                });
                if (winningCountries.length > 0) {
                    const msg = `â†’ ã„¹~ã…‡ ì „ëµ: ìŠ¹ë¦¬ ë‹¨ì–´ ë°œê²¬ (${winningCountries.length}ê°œ)`;
                    console.log(`${indent}  ${msg}`);
                    addDepthLog(msg, isComputerTurn ? 'win' : 'lose', depth - 1);
                    if (isComputerTurn) {
                        return 'computer';
                    } else {
                        return 'player';
                    }
                }
            }
            if (isComputerTurn) {
                let allWin = true;
                const msg = `ì»´í“¨í„° ì„ íƒ ê°€ëŠ¥í•œ ë‹¨ì–´ë“¤:`;
                console.log(`${indent}  ${msg}`);
                addDepthLog(msg, 'info', depth - 1);
                for (const country of nonLoopAvailable) {
                    const nextUsed = [...usedCountries, country];
                    const nextAvailable = getAvailableCountries(nextUsed, country);
                    const nextNonLoopAvailable = nextAvailable.filter(c => !isLoopCountry(c, nextAvailable));
                    const result = calculateDepth(nextUsed, country, false, depth + 1, maxDepth, nextNonLoopAvailable);
                    const resultMsg = `"${country}" ì„ íƒ ì‹œ ê²°ê³¼: ${result === 'player' ? 'ì»´í“¨í„° íŒ¨ë°°' : result === 'computer' ? 'ì»´í“¨í„° ìŠ¹ë¦¬' : 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
                    console.log(`${indent}    ${resultMsg}`);
                    addDepthLog(resultMsg, result === 'computer' ? 'win' : result === 'player' ? 'lose' : 'unknown', depth);
                    if (result === 'computer') {
                        const winMsg = `â†’ ìŠ¹ë¦¬ ê°€ëŠ¥í•œ ë‹¨ì–´ ë°œê²¬, ì¦‰ì‹œ ë°˜í™˜`;
                        console.log(`${indent}  ${winMsg}`);
                        addDepthLog(winMsg, 'win', depth - 1);
                        return 'computer';
                    }
                    if (result !== 'computer' && result !== 'unknown') {
                        allWin = false;
                    }
                }
                const finalResult = allWin ? 'computer' : 'player';
                const finalMsg = `â†’ ìµœì¢… ê²°ê³¼: ${finalResult === 'player' ? 'ì»´í“¨í„° íŒ¨ë°°' : 'ì»´í“¨í„° ìŠ¹ë¦¬'} (ëª¨ë“  ê²½ìš° ìŠ¹ë¦¬: ${allWin})`;
                console.log(`${indent}  ${finalMsg}`);
                addDepthLog(finalMsg, finalResult === 'computer' ? 'win' : 'lose', depth - 1);
                return finalResult;
            } else {
                let allWin = true;
                const msg = `í”Œë ˆì´ì–´ ì„ íƒ ê°€ëŠ¥í•œ ë‹¨ì–´ë“¤:`;
                console.log(`${indent}  ${msg}`);
                addDepthLog(msg, 'info', depth - 1);
                for (const country of nonLoopAvailable) {
                    const nextUsed = [...usedCountries, country];
                    const nextAvailable = getAvailableCountries(nextUsed, country);
                    const nextNonLoopAvailable = nextAvailable.filter(c => !isLoopCountry(c, nextAvailable));
                    const result = calculateDepth(nextUsed, country, true, depth + 1, maxDepth, nextNonLoopAvailable);
                    const resultMsg = `"${country}" ì„ íƒ ì‹œ ê²°ê³¼: ${result === 'computer' ? 'í”Œë ˆì´ì–´ íŒ¨ë°°' : result === 'player' ? 'í”Œë ˆì´ì–´ ìŠ¹ë¦¬' : 'ì•Œ ìˆ˜ ì—†ìŒ'}`;
                    console.log(`${indent}    ${resultMsg}`);
                    addDepthLog(resultMsg, result === 'player' ? 'win' : result === 'computer' ? 'lose' : 'unknown', depth);
                    if (result !== 'player' && result !== 'unknown') {
                        allWin = false;
                    }
                }
                const finalResult = allWin ? 'player' : 'computer';
                const finalMsg = `â†’ ìµœì¢… ê²°ê³¼: ${finalResult === 'computer' ? 'í”Œë ˆì´ì–´ íŒ¨ë°°' : 'í”Œë ˆì´ì–´ ìŠ¹ë¦¬'} (ëª¨ë“  ê²½ìš° ìŠ¹ë¦¬: ${allWin})`;
                console.log(`${indent}  ${finalMsg}`);
                addDepthLog(finalMsg, finalResult === 'player' ? 'win' : 'lose', depth - 1);
                return finalResult;
            }
        }
        function selectBestCountryWithDepth(available, usedCountries, lastCountry, maxDepth) {
            clearDepthLog();
            const headerMsg = `=== Depth ${maxDepth} ìˆ˜ ì½ê¸° ì‹œì‘ ===`;
            console.log(`\n${headerMsg}`);
            addDepthLog(headerMsg, 'info', 0);
            
            const infoMsg1 = `í˜„ì¬ ë§ˆì§€ë§‰ ë‚˜ë¼: ${lastCountry || 'ì—†ìŒ'}`;
            console.log(infoMsg1);
            addDepthLog(infoMsg1, 'info', 0);
            
            const infoMsg2 = `ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¨ì–´: ${available.length}ê°œ`;
            console.log(infoMsg2);
            addDepthLog(infoMsg2, 'info', 0);
            
            const nonLoopAvailable = available.filter(c => !isLoopCountry(c, available));
            const infoMsg3 = `ëŒë¦¼ë‹¨ì–´ ì œì™¸ í›„: ${nonLoopAvailable.length}ê°œ`;
            console.log(infoMsg3);
            addDepthLog(infoMsg3, 'info', 0);
            
            if (nonLoopAvailable.length === 0) {
                const msg1 = 'ëŒë¦¼ë‹¨ì–´ ì œì™¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¨ì–´ ì—†ìŒ';
                const msg2 = 'â†’ ì„ íƒ ë¶ˆê°€';
                console.log(msg1);
                console.log(msg2);
                addDepthLog(msg1, 'lose', 0);
                addDepthLog(msg2, 'lose', 0);
                updateDepthDisplay();
                return null;
            }
            const winningCountries = [];
            const losingCountries = [];
            const unknownCountries = [];
            
            const calcMsg = `ê° ë‹¨ì–´ë³„ depth ê³„ì‚°:`;
            console.log(`\n${calcMsg}`);
            addDepthLog(calcMsg, 'info', 0);
            
            for (const country of nonLoopAvailable) {
                const nextUsed = [...usedCountries, country];
                const nextAvailable = getAvailableCountries(nextUsed, country);
                const nextNonLoopAvailable = nextAvailable.filter(c => !isLoopCountry(c, nextAvailable));
                const result = calculateDepth(nextUsed, country, false, 1, maxDepth, nextNonLoopAvailable);
                if (result === 'computer') {
                    const winMsg = `"${country}": ì»´í“¨í„° ìŠ¹ë¦¬ âœ“`;
                    const selectMsg = `â†’ ì¦‰ì‹œ ì„ íƒ: "${country}" (ìŠ¹ë¦¬ ê°€ëŠ¥í•œ ë‹¨ì–´ ë°œê²¬, íƒìƒ‰ ì¢…ë£Œ)`;
                    console.log(winMsg);
                    console.log(selectMsg);
                    addDepthLog(winMsg, 'win', 0);
                    addDepthLog(selectMsg, 'selected', 0);
                    updateDepthDisplay();
                    return country;
                } else if (result === 'player') {
                    losingCountries.push(country);
                    const loseMsg = `"${country}": ì»´í“¨í„° íŒ¨ë°° âœ—`;
                    console.log(loseMsg);
                    addDepthLog(loseMsg, 'lose', 0);
                } else {
                    unknownCountries.push(country);
                    const unknownMsg = `"${country}": ì•Œ ìˆ˜ ì—†ìŒ ?`;
                    console.log(unknownMsg);
                    addDepthLog(unknownMsg, 'unknown', 0);
                }
            }
            
            const summaryMsg1 = `ê²°ê³¼ ìš”ì•½:`;
            const summaryMsg2 = `  ìŠ¹ë¦¬ ê°€ëŠ¥: 0ê°œ`;
            const summaryMsg3 = `  íŒ¨ë°° í™•ì •: ${losingCountries.length}ê°œ`;
            const summaryMsg4 = `  ì•Œ ìˆ˜ ì—†ìŒ: ${unknownCountries.length}ê°œ`;
            console.log(`\n${summaryMsg1}`);
            console.log(summaryMsg2);
            console.log(summaryMsg3);
            console.log(summaryMsg4);
            addDepthLog(summaryMsg1, 'info', 0);
            addDepthLog(summaryMsg2, 'info', 0);
            addDepthLog(summaryMsg3, 'info', 0);
            addDepthLog(summaryMsg4, 'info', 0);
            
            const remaining = nonLoopAvailable.filter(c => !losingCountries.includes(c));
            if (remaining.length > 0) {
                const selected = remaining[Math.floor(Math.random() * remaining.length)];
                const selectMsg = `â†’ ì„ íƒ: "${selected}" (íŒ¨ë°°í•˜ì§€ ì•ŠëŠ” ë‹¨ì–´ ì¤‘ ëœë¤)`;
                console.log(selectMsg);
                addDepthLog(selectMsg, 'selected', 0);
                updateDepthDisplay();
                return selected;
            }
            const noSelectMsg = `â†’ ì„ íƒ ë¶ˆê°€ (ëª¨ë“  ë‹¨ì–´ê°€ íŒ¨ë°° í™•ì •)`;
            console.log(noSelectMsg);
            addDepthLog(noSelectMsg, 'lose', 0);
            updateDepthDisplay();
            return null;
        }
        function updateStatsDisplay() {
            const stats = getStats();
            const winRate = stats.totalGames > 0 
                ? Math.round((stats.wins / stats.totalGames) * 100) 
                : 0;
            document.getElementById('wins').textContent = stats.wins;
            document.getElementById('losses').textContent = stats.losses;
            document.getElementById('totalGames').textContent = stats.totalGames;
            document.getElementById('winRate').textContent = winRate + '%';
            const winsMobile = document.getElementById('winsMobile');
            const lossesMobile = document.getElementById('lossesMobile');
            const totalGamesMobile = document.getElementById('totalGamesMobile');
            const winRateMobile = document.getElementById('winRateMobile');
            if (winsMobile) winsMobile.textContent = stats.wins;
            if (lossesMobile) lossesMobile.textContent = stats.losses;
            if (totalGamesMobile) totalGamesMobile.textContent = stats.totalGames;
            if (winRateMobile) winRateMobile.textContent = winRate + '%';
        }
        function recordWin() {
            const stats = getStats();
            stats.wins++;
            stats.totalGames++;
            saveStats(stats);
            saveGameState();
            updateStatsDisplay();
        }
        function recordLoss() {
            const stats = getStats();
            stats.losses++;
            stats.totalGames++;
            saveStats(stats);
            saveGameState();
            updateStatsDisplay();
        }
        function surrender() {
            if (gameState.gameEnded) {
                showMessage('ì´ë¯¸ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (confirm('ì •ë§ ê¸°ê¶Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? íŒ¨ë°°ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤.')) {
                gameState.gameEnded = true;
                showMessage('ğŸ˜¢ ê¸°ê¶Œí•˜ì…¨ìŠµë‹ˆë‹¤. ì»´í“¨í„°ê°€ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!', 'error');
                recordLoss();
                updateGameInfo();
            }
        }
        function isComputerTrapped() {
            const available = getAvailableCountries(gameState.usedCountries, gameState.lastCountry);
            if (available.length === 0) {
                return true;
            }
            const allEndWithDOrR = available.every(country => {
                const lastInitial = getLastCharInitial(country);
                return lastInitial === 'ã„·' || lastInitial === 'ã„¹';
            });
            if (allEndWithDOrR && available.length > 0) {
                return true;
            }
            const grenadaUsed = gameState.usedCountries.includes('ê·¸ë ˆë‚˜ë‹¤');
            const dToGCount = gameState.usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„·' && last === 'ã„±';
            }).length;
            if (dToGCount === 1 && !grenadaUsed) {
                const dEnding = available.filter(c => getLastCharInitial(c) === 'ã„·');
                if (dEnding.length === 0) {
                    return true;
                }
            }
            const rToYCount = gameState.usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„¹' && last === 'ã…‡';
            }).length;
            const yToRCount = gameState.usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã…‡' && last === 'ã„¹';
            }).length;
            if (rToYCount - yToRCount > 0) {
                const rEnding = available.filter(c => getLastCharInitial(c) === 'ã„¹');
                if (rEnding.length === 0) {
                    return true;
                }
            }
            return false;
        }
        function exportGameHistory() {
            const historyEl = document.getElementById('history');
            if (!historyEl || historyEl.children.length === 0) {
                showMessage('ì €ì¥í•  ê²Œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            let textHistory = 'ë‚˜ë¼ ëë§ì‡ê¸° ê²Œì„ ê¸°ë¡\n';
            textHistory += '='.repeat(30) + '\n\n';
            gameHistory.forEach((item, index) => {
                const playerName = item.player === 'user' ? 'ë‚˜' : 'ì»´í“¨í„°';
                textHistory += `${index + 1}. ${playerName}: ${item.country}\n`;
            });
            textHistory += '\n' + '='.repeat(30) + '\n';
            textHistory += `ì´ ${gameHistory.length}ìˆ˜\n`;
            textHistory += `ì‚¬ìš©ëœ ë‚˜ë¼: ${gameState.usedCountries.length}ê°œ\n`;
            navigator.clipboard.writeText(textHistory).then(() => {
                showMessage('ê²Œì„ ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = textHistory;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showMessage('ê²Œì„ ê¸°ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            });
        }
        function selectTurn(player) {
            if (gameState.firstTurnDone) {
                showMessage('ê²Œì„ì´ ì‹œì‘ëœ í›„ì—ëŠ” ì„ ê³µ/í›„ê³µì„ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            gameState.firstPlayer = player;
            gameState.currentPlayer = player;
            document.getElementById('turnBtnUser').classList.remove('selected');
            document.getElementById('turnBtnComputer').classList.remove('selected');
            if (player === 'user') {
                document.getElementById('turnBtnUser').classList.add('selected');
                showMessage('ë‹¹ì‹ ì´ ì„ ê³µì…ë‹ˆë‹¤! ë‚˜ë¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'info');
            } else {
                document.getElementById('turnBtnComputer').classList.add('selected');
                showMessage('ì»´í“¨í„°ê°€ ì„ ê³µì…ë‹ˆë‹¤!', 'info');
                setTimeout(() => {
                    computerTurn();
                }, 20);
            }
            if (!gameState.firstTurnDone) {
                const stealSection = document.getElementById('stealSection');
                if (stealSection) {
                    stealSection.style.display = 'none';
                }
            }
        }
        function toggleLeftPanel() {
            const panel = document.getElementById('mobileLeftPanel');
            const overlay = document.getElementById('panelOverlay');
            const rightPanel = document.getElementById('mobileRightPanel');
            if (panel.classList.contains('show')) {
                closeLeftPanel();
            } else {
                rightPanel.classList.remove('show');
                panel.classList.add('show');
                overlay.classList.add('show');
            }
        }
        function toggleRightPanel() {
            const panel = document.getElementById('mobileRightPanel');
            const overlay = document.getElementById('panelOverlay');
            const leftPanel = document.getElementById('mobileLeftPanel');
            if (!panel || !overlay) {
                console.error('íŒ¨ë„ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            if (panel.classList.contains('show')) {
                closeRightPanel();
            } else {
                leftPanel.classList.remove('show');
                panel.classList.add('show');
                overlay.classList.add('show');
                updateAvailableCountries();
            }
        }
        function closeLeftPanel() {
            document.getElementById('mobileLeftPanel').classList.remove('show');
            checkPanelsClosed();
        }
        function closeRightPanel() {
            document.getElementById('mobileRightPanel').classList.remove('show');
            checkPanelsClosed();
        }
        function closeAllPanels() {
            document.getElementById('mobileLeftPanel').classList.remove('show');
            document.getElementById('mobileRightPanel').classList.remove('show');
            document.getElementById('panelOverlay').classList.remove('show');
        }
        function checkPanelsClosed() {
            const leftPanel = document.getElementById('mobileLeftPanel');
            const rightPanel = document.getElementById('mobileRightPanel');
            const overlay = document.getElementById('panelOverlay');
            if (!leftPanel.classList.contains('show') && !rightPanel.classList.contains('show')) {
                overlay.classList.remove('show');
            }
        }
        window.addEventListener('DOMContentLoaded', function() {
            const loaded = loadGameState();
            if (loaded) {
                document.getElementById('turnBtnUser').classList.remove('selected');
                document.getElementById('turnBtnComputer').classList.remove('selected');
                if (gameState.firstPlayer === 'user') {
                    document.getElementById('turnBtnUser').classList.add('selected');
                } else {
                    document.getElementById('turnBtnComputer').classList.add('selected');
                }
                if (gameState.firstTurnDone) {
                    disableGameSettings();
                }
                const historyEl = document.getElementById('history');
                historyEl.innerHTML = '';
                gameHistory.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = `history-item ${item.player}`;
                    historyItem.textContent = `${item.player === 'user' ? 'ğŸ‘¤ ë‚˜' : 'ğŸ¤– ì»´í“¨í„°'}: ${item.country}`;
                    historyEl.appendChild(historyItem);
                });
                historyEl.scrollTop = historyEl.scrollHeight;
                showMessage('ì´ì „ ê²Œì„ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
            updateUndoButton();
            updateAvailableCountries();
            updateStatsDisplay();
            updateGameInfo();
        });
        function openSearch() {
            const overlay = document.getElementById('searchOverlay');
            overlay.classList.add('show');
            document.getElementById('searchInput').focus();
            document.body.style.overflow = 'hidden';
        }
        function closeSearch(event) {
            if (event && event.target !== event.currentTarget) {
                return;
            }
            const overlay = document.getElementById('searchOverlay');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
        }
        function addToHistory(country, player) {
            const historyEl = document.getElementById('history');
            const item = document.createElement('div');
            item.className = `history-item ${player}`;
            item.textContent = `${player === 'user' ? 'ğŸ‘¤ ë‚˜' : 'ğŸ¤– ì»´í“¨í„°'}: ${country}`;
            historyEl.appendChild(item);
            historyEl.scrollTop = historyEl.scrollHeight;
            gameHistory.push({
                country: country,
                player: player,
                usedCountries: [...gameState.usedCountries],
                lastCountry: gameState.lastCountry,
                currentPlayer: gameState.currentPlayer,
                firstTurnDone: gameState.firstTurnDone,
                firstTurnCountry: gameState.firstTurnCountry,
                gameEnded: gameState.gameEnded
            });
            updateUndoButton();
        }
        function updateUndoButton() {
            const undoBtn = document.getElementById('undoBtn');
            if (gameHistory.length === 0) {
                undoBtn.disabled = true;
                undoBtn.style.opacity = '0.5';
                undoBtn.style.cursor = 'not-allowed';
            } else {
                undoBtn.disabled = false;
                undoBtn.style.opacity = '1';
                undoBtn.style.cursor = 'pointer';
            }
        }
        function undoMove() {
            if (gameHistory.length === 0) {
                showMessage('ë¬´ë¥¼ ìˆ˜ ìˆëŠ” í„´ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            let itemsToRemove = 2;
            if (gameHistory.length < 2) {
                itemsToRemove = gameHistory.length;
            }
            for (let i = 0; i < itemsToRemove; i++) {
                gameHistory.pop();
            }
            if (gameHistory.length === 0) {
                gameState.usedCountries = [];
                gameState.lastCountry = null;
                gameState.currentPlayer = gameState.firstPlayer;
                gameState.firstTurnDone = false;
                gameState.firstTurnCountry = null;
                gameState.gameEnded = false;
            } else {
                const prevState = gameHistory[gameHistory.length - 1];
                gameState.usedCountries = [...prevState.usedCountries];
                gameState.lastCountry = prevState.lastCountry;
                gameState.currentPlayer = prevState.currentPlayer;
                gameState.firstTurnDone = prevState.firstTurnDone;
                gameState.firstTurnCountry = prevState.firstTurnCountry;
                gameState.gameEnded = prevState.gameEnded;
            }
            const historyEl = document.getElementById('history');
            historyEl.innerHTML = '';
            gameHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${item.player}`;
                historyItem.textContent = `${item.player === 'user' ? 'ğŸ‘¤ ë‚˜' : 'ğŸ¤– ì»´í“¨í„°'}: ${item.country}`;
                historyEl.appendChild(historyItem);
            });
            historyEl.scrollTop = historyEl.scrollHeight;
            updateAvailableCountries();
            updateGameInfo();
            updateUndoButton();
            saveGameState();
            showMessage(itemsToRemove === 2 ? 'í•œ í„´ì„ ë¬´ë¥´ê¸°í–ˆìŠµë‹ˆë‹¤.' : 'ë¬´ë¥´ê¸°ë¥¼ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤.', 'info');
        }
        function submitCountry(country) {
            if (!country) {
                showMessage('ë‚˜ë¼ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (gameState.firstPlayer === 'computer' && 
                !gameState.firstTurnDone && 
                gameState.firstTurnCountry && 
                country === gameState.firstTurnCountry &&
                gameState.currentPlayer === 'user') {
                gameState.usedCountries = [country];
                gameState.lastCountry = country;
                gameState.firstPlayer = 'user'; 
                gameState.currentPlayer = 'user';
                gameState.firstTurnDone = true;
                gameState.firstTurnCountry = null;
                addToHistory(country + ' (ëºê¸°)', 'user');
                saveGameState();
                showMessage(`"${country}"ë¥¼ ëºì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë‹¹ì‹ ì´ ì„ ê³µì…ë‹ˆë‹¤.`, 'success');
                updateAvailableCountries();
                updateGameInfo();
                return;
            }
            if (gameState.lastCountry === null) {
                if (!findCountry(country)) {
                    showMessage(`"${country}"ëŠ” ìœ íš¨í•œ ë‚˜ë¼ ì´ë¦„ì´ ì•„ë‹™ë‹ˆë‹¤.`, 'error');
                    return;
                }
                if (gameState.usedCountries.includes(country)) {
                    showMessage(`"${country}"ëŠ” ì´ë¯¸ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'error');
                    return;
                }
                if (!gameState.firstTurnDone && gameState.firstPlayer === 'user') {
                    gameState.firstTurnCountry = country;
                }
                gameState.usedCountries.push(country);
                gameState.lastCountry = country;
                gameState.currentPlayer = 'computer';
                if (!gameState.firstTurnDone) {
                    gameState.firstTurnDone = true;
                    disableGameSettings();
                }
                addToHistory(country, 'user');
                saveGameState();
                showMessage(`ì¢‹ìŠµë‹ˆë‹¤! "${country}" ë‹¤ìŒì— ì˜¬ ìˆ˜ ìˆëŠ” ë‚˜ë¼ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.`, 'success');
                updateAvailableCountries();
                updateGameInfo();
                setTimeout(() => {
                    computerTurn();
                }, 20);
                return;
            }
            const lastInitial = getLastCharInitial(gameState.lastCountry);
            const currentInitial = getFirstCharInitial(country);
            if (lastInitial !== currentInitial) {
                showMessage(`"${gameState.lastCountry}"ì˜ ë§ˆì§€ë§‰ ê¸€ì(${lastInitial})ë¡œ ì‹œì‘í•˜ëŠ” ë‚˜ë¼ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`, 'error');
                return;
            }
            if (!findCountry(country)) {
                showMessage(`"${country}"ëŠ” ìœ íš¨í•œ ë‚˜ë¼ ì´ë¦„ì´ ì•„ë‹™ë‹ˆë‹¤.`, 'error');
                return;
            }
            if (gameState.usedCountries.includes(country)) {
                showMessage(`"${country}"ëŠ” ì´ë¯¸ ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'error');
                return;
            }
            gameState.usedCountries.push(country);
            gameState.lastCountry = country;
            gameState.currentPlayer = 'computer';
            addToHistory(country, 'user');
            saveGameState();
            showMessage(`ì •ë‹µì…ë‹ˆë‹¤! "${country}" ë‹¤ìŒì— ì˜¬ ìˆ˜ ìˆëŠ” ë‚˜ë¼ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.`, 'success');
            updateAvailableCountries();
            setTimeout(() => {
                computerTurn();
            }, 20);
        }
        function chooseStrategicCountry(available) {
            const grenadaUsed = gameState.usedCountries.includes('ê·¸ë ˆë‚˜ë‹¤');
            if (gameState.lastCountry && gameState.currentPlayer === 'computer') {
                const availableWithLastCountry = [...available, gameState.lastCountry];
                const lastCountryIsLoop = isLoopCountry(gameState.lastCountry, availableWithLastCountry);
                if (lastCountryIsLoop) {
                    const loopCountries = available.filter(c => isLoopCountry(c, available));
                    if (loopCountries.length > 0) {
                        return loopCountries[Math.floor(Math.random() * loopCountries.length)];
                    }
                }
            }
            const dToGCount = gameState.usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„·' && last === 'ã„±';
            }).length;
            if (dToGCount === 1 && !grenadaUsed) {
                const dEnding = available.filter(c => getLastCharInitial(c) === 'ã„·' && !isLoopCountry(c, available));
                if (dEnding.length > 0) {
                    return dEnding[0];
                }
            }
            const rToYCount = gameState.usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„¹' && last === 'ã…‡';
            }).length;
            const yToRCount = gameState.usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã…‡' && last === 'ã„¹';
            }).length;
            if (rToYCount - yToRCount > 0) {
                const rEnding = available.filter(c => getLastCharInitial(c) === 'ã„¹' && !isLoopCountry(c, available));
                if (rEnding.length > 0) {
                    return rEnding[0];
                }
            }
            const dToGUsed = gameState.usedCountries.filter(c => {
                const first = getFirstCharInitial(c);
                const last = getLastCharInitial(c);
                return first === 'ã„·' && last === 'ã„±';
            });
            if (dToGUsed.length >= 2) {
                const dEnding = available.filter(c => getLastCharInitial(c) === 'ã„·' && !isLoopCountry(c, available));
                if (dEnding.length > 0) {
                    if (dEnding.includes('ê·¸ë ˆë‚˜ë‹¤') && !grenadaUsed) {
                        return 'ê·¸ë ˆë‚˜ë‹¤';
                    }
                    return dEnding[0];
                }
            }
            if (grenadaUsed && dToGUsed.length >= 1) {
                const dEnding = available.filter(c => getLastCharInitial(c) === 'ã„·' && !isLoopCountry(c, available));
                if (dEnding.length > 0) {
                    return dEnding[0];
                }
            }
            if (gameState.firstPlayer !== 'computer') {
                const dToGCountries = available.filter(c => {
                    const first = getFirstCharInitial(c);
                    const last = getLastCharInitial(c);
                    return first === 'ã„·' && last === 'ã„±' && !isLoopCountry(c, available);
                });
                if (dToGCountries.length > 0) {
                    const unusedDToG = dToGCountries.filter(c => !gameState.usedCountries.includes(c));
                    if (unusedDToG.length > 0) {
                        return unusedDToG[0];
                    }
                }
            }
            if (gameState.firstPlayer !== 'computer') {
                const rToYCountries = available.filter(c => {
                    const first = getFirstCharInitial(c);
                    const last = getLastCharInitial(c);
                    return first === 'ã„¹' && last === 'ã…‡' && !isLoopCountry(c, available);
                });
                if (rToYCountries.length > 0) {
                    const unusedRToY = rToYCountries.filter(c => !gameState.usedCountries.includes(c));
                    if (unusedRToY.length > 0) {
                        return unusedRToY[0];
                    }
                }
            }
            if (gameState.lastCountry === 'ë¥´ì™„ë‹¤') {
                const eastTimor = available.find(c => c === 'ë™í‹°ëª¨ë¥´' && !isLoopCountry(c, available));
                if (eastTimor) {
                    return eastTimor;
                }
            }
            const safeEndings = ['ã„±', 'ã„¹', 'ã…Œ', 'ã…', 'ã…']; 
            const safeEndingCountries = available.filter(c => {
                const ending = getLastCharInitial(c);
                return safeEndings.includes(ending);
            });
            const nonLoopSafe = safeEndingCountries.filter(c => !isLoopCountry(c, available));
            if (nonLoopSafe.length > 0) {
                const rEndingNonLoop = nonLoopSafe.filter(c => getLastCharInitial(c) === 'ã„¹');
                if (rEndingNonLoop.length > 0) {
                    const eastTimorUsed = gameState.usedCountries.includes('ë™í‹°ëª¨ë¥´');
                    const lesotho = rEndingNonLoop.find(c => c === 'ë ˆì†Œí† ');
                    if (lesotho && !eastTimorUsed) {
                        return lesotho;
                    }
                    if (eastTimorUsed) {
                        const rwanda = rEndingNonLoop.find(c => c === 'ë¥´ì™„ë‹¤');
                        if (rwanda) return rwanda;
                    }
                    return rEndingNonLoop[0];
                }
                return nonLoopSafe[0];
            }
            const nonLoopSafeEndingCountries = safeEndingCountries.filter(c => !isLoopCountry(c, available));
            if (nonLoopSafeEndingCountries.length > 0) {
                const rEndingCountries = nonLoopSafeEndingCountries.filter(c => getLastCharInitial(c) === 'ã„¹');
                if (rEndingCountries.length > 0) {
                    const eastTimorUsed = gameState.usedCountries.includes('ë™í‹°ëª¨ë¥´');
                    const lesotho = rEndingCountries.find(c => c === 'ë ˆì†Œí† ');
                    if (lesotho && !eastTimorUsed) {
                        return lesotho;
                    }
                    if (eastTimorUsed) {
                        const rwanda = rEndingCountries.find(c => c === 'ë¥´ì™„ë‹¤');
                        if (rwanda) return rwanda;
                    }
                    return rEndingCountries[0];
                }
                return nonLoopSafeEndingCountries[0];
            }
            if (gameState.lastCountry && gameState.currentPlayer === 'computer') {
                const lastEnding = getLastCharInitial(gameState.lastCountry);
                if (lastEnding === 'ã„·' || lastEnding === 'ã„¹') {
                    const safeCountries = available.filter(c => {
                        const first = getFirstCharInitial(c);
                        return first !== lastEnding && !isLoopCountry(c, available);
                    });
                    if (safeCountries.length > 0) {
                        available = safeCountries;
                    }
                }
            }
            if (gameState.firstPlayer !== 'computer') {
                const dEnding = available.filter(c => getLastCharInitial(c) === 'ã„·' && !isLoopCountry(c, available));
                const dToGInDEnding = dEnding.filter(c => {
                    const first = getFirstCharInitial(c);
                    const last = getLastCharInitial(c);
                    return first === 'ã„·' && last === 'ã„±' && !gameState.usedCountries.includes(c);
                });
                if (dToGInDEnding.length > 0) {
                    return dToGInDEnding[0];
                }
            }
            const nonLoopAvailable = available.filter(c => !isLoopCountry(c, available));
            if (nonLoopAvailable.length > 0) {
                return nonLoopAvailable[Math.floor(Math.random() * nonLoopAvailable.length)];
            }
            return null;
        }
        function computerTurn() {
            const available = getAvailableCountries(gameState.usedCountries, gameState.lastCountry);
            if (available.length === 0) {
                if (!gameState.gameEnded) {
                    gameState.gameEnded = true;
                    showMessage('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ì»´í“¨í„°ê°€ ë” ì´ìƒ ë‹µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì´ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!', 'success');
                    recordWin();
                }
                return;
            }
            if (gameState.firstPlayer === 'user' && 
                !gameState.firstTurnDone && 
                gameState.firstTurnCountry && 
                gameState.currentPlayer === 'computer') {
                const firstTurnLastInitial = getLastCharInitial(gameState.firstTurnCountry);
                if (gameState.firstTurnCountry === 'ê·¸ë ˆë‚˜ë‹¤' || gameState.firstTurnCountry === 'ê³¼í…Œë§ë¼') {
                } else if (firstTurnLastInitial === 'ã„·' || firstTurnLastInitial === 'ã„¹') {
                    const stolenCountry = gameState.firstTurnCountry;
                    gameState.usedCountries = [stolenCountry];
                    gameState.lastCountry = stolenCountry;
                    gameState.firstPlayer = 'computer'; 
                    gameState.currentPlayer = 'computer';
                    gameState.firstTurnDone = true;
                    gameState.firstTurnCountry = null;
                    addToHistory(stolenCountry + ' (ëºê¸°)', 'computer');
                    saveGameState();
                    showMessage(`ì»´í“¨í„°ê°€ "${stolenCountry}"ë¥¼ ëºì—ˆìŠµë‹ˆë‹¤! ì´ì œ ì»´í“¨í„°ê°€ ì„ ê³µì…ë‹ˆë‹¤.`, 'error');
                    updateAvailableCountries();
                    updateGameInfo();
                    return;
                }
            }
            let computerChoice;
            if (gameState.lastCountry === null) {
                const safeCountries = available.filter(country => {
                    if (country === 'ê³¼í…Œë§ë¼') {
                        return true;
                    }
                    const nextAvailable = COUNTRY_NAMES.filter(c => {
                        const firstInitial = getFirstCharInitial(c);
                        const lastInitial = getLastCharInitial(country);
                        return firstInitial === lastInitial && !gameState.usedCountries.includes(c);
                    });
                    const hasStealable = nextAvailable.some(c => {
                        const lastInitial = getLastCharInitial(c);
                        return lastInitial === 'ã„·' || lastInitial === 'ã„¹';
                    });
                    return !hasStealable;
                });
                if (safeCountries.length > 0) {
                    const nonLoopSafe = safeCountries.filter(c => !isLoopCountry(c, available));
                    if (nonLoopSafe.length > 0) {
                        computerChoice = nonLoopSafe[Math.floor(Math.random() * nonLoopSafe.length)];
                    } else {
                        computerChoice = safeCountries[Math.floor(Math.random() * safeCountries.length)];
                    }
                } else {
                    const nonLoopAvailable = available.filter(c => !isLoopCountry(c, available));
                    if (nonLoopAvailable.length > 0) {
                        computerChoice = nonLoopAvailable[Math.floor(Math.random() * nonLoopAvailable.length)];
                    } else {
                        computerChoice = available[Math.floor(Math.random() * available.length)];
                    }
                }
            } else {
                const guatemalaUsed = gameState.usedCountries.includes('ê³¼í…Œë§ë¼');
                
                const yToDCountries = available.filter(c => {
                    const first = getFirstCharInitial(c);
                    const last = getLastCharInitial(c);
                    return first === 'ã…‡' && last === 'ã„·' && !isLoopCountry(c, available);
                });
                if (yToDCountries.length > 0) {
                    computerChoice = yToDCountries[Math.floor(Math.random() * yToDCountries.length)];
                }
                
                if (!computerChoice && !guatemalaUsed && available.includes('ê³¼í…Œë§ë¼')) {
                    const guatemalaAvailable = available.filter(c => c === 'ê³¼í…Œë§ë¼' && !isLoopCountry(c, available));
                    if (guatemalaAvailable.length > 0) {
                        computerChoice = 'ê³¼í…Œë§ë¼';
                    }
                }
                
                if (!computerChoice) {
                    if (guatemalaUsed) {
                        const rEnding = available.filter(c => getLastCharInitial(c) === 'ã„¹' && !isLoopCountry(c, available));
                        if (rEnding.length > 0) {
                            computerChoice = rEnding[Math.floor(Math.random() * rEnding.length)];
                        }
                    } else {
                        const dEnding = available.filter(c => getLastCharInitial(c) === 'ã„·' && !isLoopCountry(c, available));
                        if (dEnding.length > 0) {
                            computerChoice = dEnding[Math.floor(Math.random() * dEnding.length)];
                        }
                    }
                }
                
                if (!computerChoice) {
                    const depthChoice = selectBestCountryWithDepth(available, gameState.usedCountries, gameState.lastCountry, 4);
                    if (depthChoice) {
                        computerChoice = depthChoice;
                    }
                }
                
                if (!computerChoice) {
                    const grenadaUsed = gameState.usedCountries.includes('ê·¸ë ˆë‚˜ë‹¤');
                    const dToGCount = gameState.usedCountries.filter(c => {
                        const first = getFirstCharInitial(c);
                        const last = getLastCharInitial(c);
                        return first === 'ã„·' && last === 'ã„±';
                    }).length;
                    const isDWinSituation = dToGCount === 1 && !grenadaUsed;
                    if (isDWinSituation) {
                        const dEnding = available.filter(c => getLastCharInitial(c) === 'ã„·');
                        if (dEnding.length > 0) {
                            computerChoice = dEnding[Math.floor(Math.random() * dEnding.length)];
                        } else {
                            const safeEndings = ['ã„±', 'ã„¹', 'ã…‚', 'ã…ˆ', 'ã…‹', 'ã…Œ'];
                            const safeEndingCountries = available.filter(c => {
                                const lastInitial = getLastCharInitial(c);
                                return safeEndings.includes(lastInitial);
                            });
                            let found = false;
                            for (const country of safeEndingCountries) {
                                const nextAvailable = getAvailableCountries([...gameState.usedCountries, country], country);
                                const playerCanEndWithSafe = nextAvailable.some(c => {
                                    const lastInitial = getLastCharInitial(c);
                                    return safeEndings.includes(lastInitial);
                                });
                                if (!playerCanEndWithSafe) {
                                    computerChoice = country;
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                const oddCountCountries = safeEndingCountries.filter(country => {
                                    const nextAvailable = getAvailableCountries([...gameState.usedCountries, country], country);
                                    const playerSafeEndingCount = nextAvailable.filter(c => {
                                        const lastInitial = getLastCharInitial(c);
                                        return safeEndings.includes(lastInitial);
                                    }).length;
                                    return playerSafeEndingCount % 2 === 1;
                                });
                                if (oddCountCountries.length > 0) {
                                    const filtered = oddCountCountries.filter(country => {
                                        const nextAvailable = getAvailableCountries([...gameState.usedCountries, country], country);
                                        const playerSafeEndingCount = nextAvailable.filter(c => {
                                            const lastInitial = getLastCharInitial(c);
                                            return safeEndings.includes(lastInitial);
                                        }).length;
                                        if (playerSafeEndingCount % 2 === 1) {
                                            const computerNextAvailable = nextAvailable.filter(c => {
                                                const lastInitial = getLastCharInitial(c);
                                                return safeEndings.includes(lastInitial);
                                            });
                                            const computerCanWin = computerNextAvailable.some(c => {
                                                const cNextAvailable = getAvailableCountries([...gameState.usedCountries, country, c], c);
                                                const cPlayerSafeEndingCount = cNextAvailable.filter(c2 => {
                                                    const lastInitial = getLastCharInitial(c2);
                                                    return safeEndings.includes(lastInitial);
                                                }).length;
                                                return cPlayerSafeEndingCount % 2 === 0;
                                            });
                                            return computerCanWin;
                                        }
                                        return false;
                                    });
                                    if (filtered.length > 0) {
                                        computerChoice = filtered[Math.floor(Math.random() * filtered.length)];
                                    } else {
                                        computerChoice = oddCountCountries[Math.floor(Math.random() * oddCountCountries.length)];
                                    }
                                } else {
                                    computerChoice = available[Math.floor(Math.random() * available.length)];
                                }
                            }
                        }
                    }
                }
                if (!computerChoice) {
                    if (gameState.difficulty === 'hell') {
                        const safeChoices = available.filter(country => {
                            const nextAvailable = getAvailableCountries([...gameState.usedCountries, country], country);
                            if (nextAvailable.length > 0) {
                                const allEndWithDOrR = nextAvailable.every(c => {
                                    const lastInitial = getLastCharInitial(c);
                                    return lastInitial === 'ã„·' || lastInitial === 'ã„¹';
                                });
                                return !allEndWithDOrR;
                            }
                            return true;
                        });
                            if (safeChoices.length > 0) {
                                const nonLoopSafe = safeChoices.filter(c => !isLoopCountry(c, available));
                                if (nonLoopSafe.length > 0) {
                                    computerChoice = nonLoopSafe[Math.floor(Math.random() * nonLoopSafe.length)];
                                } else {
                                    computerChoice = safeChoices[Math.floor(Math.random() * safeChoices.length)];
                                }
                            } else {
                                const nonLoopAvailable = available.filter(c => !isLoopCountry(c, available));
                                if (nonLoopAvailable.length > 0) {
                                    computerChoice = nonLoopAvailable[Math.floor(Math.random() * nonLoopAvailable.length)];
                                } else {
                                    computerChoice = available[Math.floor(Math.random() * available.length)];
                                }
                            }
                    } else {
                        const safeChoices = available.filter(country => {
                            const nextAvailable = getAvailableCountries([...gameState.usedCountries, country], country);
                            if (nextAvailable.length > 0) {
                                const allEndWithDOrR = nextAvailable.every(c => {
                                    const lastInitial = getLastCharInitial(c);
                                    return lastInitial === 'ã„·' || lastInitial === 'ã„¹';
                                });
                                return !allEndWithDOrR;
                            }
                            return true;
                        });
                            if (safeChoices.length > 0) {
                                const nonLoopSafe = safeChoices.filter(c => !isLoopCountry(c, available));
                                if (nonLoopSafe.length > 0) {
                                    computerChoice = nonLoopSafe[Math.floor(Math.random() * nonLoopSafe.length)];
                                } else {
                                    computerChoice = safeChoices[Math.floor(Math.random() * safeChoices.length)];
                                }
                            } else {
                                const nonLoopAvailable = available.filter(c => !isLoopCountry(c, available));
                                if (nonLoopAvailable.length > 0) {
                                    computerChoice = nonLoopAvailable[Math.floor(Math.random() * nonLoopAvailable.length)];
                                } else {
                                    computerChoice = available[Math.floor(Math.random() * available.length)];
                                }
                            }
                    }
                }
            }
            if (!computerChoice) {
                const nonLoopAvailable = available.filter(c => !isLoopCountry(c, available));
                if (nonLoopAvailable.length > 0) {
                    computerChoice = nonLoopAvailable[Math.floor(Math.random() * nonLoopAvailable.length)];
                } else if (available.length > 0) {
                    computerChoice = available[Math.floor(Math.random() * available.length)];
                } else {
                    if (!gameState.gameEnded) {
                        gameState.gameEnded = true;
                        showMessage('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ì»´í“¨í„°ê°€ ë” ì´ìƒ ë‹µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì´ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!', 'success');
                        recordWin();
                    }
                    return;
                }
            }
            gameState.usedCountries.push(computerChoice);
            gameState.lastCountry = computerChoice;
            gameState.currentPlayer = 'user';
            if (!gameState.firstTurnDone) {
                if (gameState.firstPlayer === 'computer') {
                    gameState.firstTurnCountry = computerChoice;
                }
                gameState.firstTurnDone = true;
                disableGameSettings();
            }
            addToHistory(computerChoice, 'computer');
            saveGameState();
            updateAvailableCountries();
            const nextAvailable = getAvailableCountries(gameState.usedCountries, computerChoice);
            if (nextAvailable.length === 0) {
                if (!gameState.gameEnded) {
                    gameState.gameEnded = true;
                    showMessage('ğŸ˜¢ ì»´í“¨í„°ê°€ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ë” ì´ìƒ ë‹µí•  ìˆ˜ ìˆëŠ” ë‚˜ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    recordLoss();
                }
            } else {
                const winProbability = calculateWinProbability(computerChoice, gameState.usedCountries);
                const nextInitial = getLastCharInitial(computerChoice);
                showMessage(`ì»´í“¨í„°: "${computerChoice}" (ë‹¤ìŒ: ${nextInitial}ë¡œ ì‹œì‘í•˜ëŠ” ë‚˜ë¼, ìŠ¹ë¦¬: ${winProbability}%)`, 'info');
            }
        }
        function isLoopCountry(country, availableCountries) {
            if (LOOP_COUNTRIES.has(country)) {
                return true;
            }
            const firstInitial = getFirstCharInitial(country);
            const lastInitial = getLastCharInitial(country);
            if (!firstInitial || !lastInitial) return false;
            const samePairCount = availableCountries.filter(c => {
                const cFirst = getFirstCharInitial(c);
                const cLast = getLastCharInitial(c);
                return cFirst === firstInitial && cLast === lastInitial;
            }).length;
            const reversePairCount = availableCountries.filter(c => {
                const cFirst = getFirstCharInitial(c);
                const cLast = getLastCharInitial(c);
                return cFirst === lastInitial && cLast === firstInitial;
            }).length;
            if (reversePairCount > 0) {
                const maxMatched = Math.min(samePairCount, reversePairCount);
                const samePairCountries = availableCountries.filter(c => {
                    const cFirst = getFirstCharInitial(c);
                    const cLast = getLastCharInitial(c);
                    return cFirst === firstInitial && cLast === lastInitial;
                }).sort(); 
                const countryIndex = samePairCountries.indexOf(country);
                return countryIndex < maxMatched;
            }
            return false;
        }
        function updateGameInfo() {
            const usedCount = gameState.usedCountries.length;
            const lastCountry = gameState.lastCountry || '-';
            const nextInitial = gameState.lastCountry ? (getLastCharInitial(gameState.lastCountry) || '-') : '-';
            const turnText = gameState.currentPlayer === 'user' ? 'ë‚˜' : 'ì»´í“¨í„°';
            document.getElementById('usedCount').textContent = usedCount;
            document.getElementById('lastCountryDisplay').textContent = lastCountry;
            document.getElementById('nextInitialDisplay').textContent = nextInitial;
            document.getElementById('currentTurnDisplay').textContent = `í˜„ì¬ ì°¨ë¡€: ${turnText}`;
            const usedCountMobile = document.getElementById('usedCountMobile');
            const lastCountryDisplayMobile = document.getElementById('lastCountryDisplayMobile');
            const nextInitialDisplayMobile = document.getElementById('nextInitialDisplayMobile');
            const currentTurnDisplayMobile = document.getElementById('currentTurnDisplayMobile');
            if (usedCountMobile) usedCountMobile.textContent = usedCount;
            if (lastCountryDisplayMobile) lastCountryDisplayMobile.textContent = lastCountry;
            if (nextInitialDisplayMobile) nextInitialDisplayMobile.textContent = nextInitial;
            if (currentTurnDisplayMobile) currentTurnDisplayMobile.textContent = `í˜„ì¬ ì°¨ë¡€: ${turnText}`;
        }
        function updateAvailableCountries() {
            const available = getAvailableCountries(gameState.usedCountries, gameState.lastCountry);
            const listEl = document.getElementById('availableCountriesList');
            const listElMobile = document.getElementById('availableCountriesListMobile');
            const availableCount = available.length;
            document.getElementById('availableCount').textContent = availableCount;
            const availableCountMobile = document.getElementById('availableCountMobile');
            if (availableCountMobile) availableCountMobile.textContent = availableCount;
            const emptyMessage = '<div style="grid-column: 1/-1; color: #666; text-align: center; padding: 20px;">ë” ì´ìƒ ê°€ëŠ¥í•œ ë‚˜ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            if (available.length === 0) {
                listEl.innerHTML = emptyMessage;
                if (listElMobile) listElMobile.innerHTML = emptyMessage;
                updateGameInfo();
                return;
            }
            const loopCountries = [];
            const seenPairs = new Set();
            const topNonLoopCountries = [];
            const bottomNonLoopCountries = [];
            
            available.forEach(country => {
                if (isLoopCountry(country, available)) {
                    loopCountries.push(country);
                } else {
                    const firstInitial = getFirstCharInitial(country);
                    const lastInitial = getLastCharInitial(country);
                    const pairKey = `${firstInitial}-${lastInitial}`;
                    
                    if (seenPairs.has(pairKey)) {
                        bottomNonLoopCountries.push(country);
                    } else {
                        seenPairs.add(pairKey);
                        topNonLoopCountries.push(country);
                    }
                }
            });
            
            const sortedCountries = [...topNonLoopCountries, ...bottomNonLoopCountries, ...loopCountries];
            const countryHTML = sortedCountries.map(country => {
                const isLoop = loopCountries.includes(country);
                const tagClass = isLoop ? 'available-country-tag' : 'available-country-tag non-loop';
                return `<div class="${tagClass}" onclick="selectCountry('${country}')">${country}</div>`;
            }).join('');
            listEl.innerHTML = countryHTML;
            if (listElMobile) listElMobile.innerHTML = countryHTML;
            updateGameInfo();
        }
        function selectCountry(country) {
            if (gameState.gameEnded) {
                showMessage('ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            if (gameState.currentPlayer !== 'user') {
                showMessage('ì§€ê¸ˆì€ ì»´í“¨í„° ì°¨ë¡€ì…ë‹ˆë‹¤.', 'error');
                return;
            }
            if (!country) {
                showMessage('ë‚˜ë¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            submitCountry(country);
        }
        function toggleAvailableCountries() {
            const section = document.getElementById('availableCountriesSection');
            const btn = section.querySelector('.toggle-btn');
            const list = document.getElementById('availableCountriesList');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                btn.textContent = 'ìˆ¨ê¸°ê¸°';
            } else {
                section.classList.add('hidden');
                btn.textContent = 'ë³´ê¸°';
            }
        }
        function disableGameSettings() {
            document.getElementById('turnBtnUser').disabled = true;
            document.getElementById('turnBtnComputer').disabled = true;
            document.getElementById('turnBtnUser').style.opacity = '0.5';
            document.getElementById('turnBtnComputer').style.opacity = '0.5';
        }
        function enableGameSettings() {
            document.getElementById('turnBtnUser').disabled = false;
            document.getElementById('turnBtnComputer').disabled = false;
            document.getElementById('turnBtnUser').style.opacity = '1';
            document.getElementById('turnBtnComputer').style.opacity = '1';
        }
        function startNewGame() {
            gameState.usedCountries = [];
            gameState.lastCountry = null;
            gameState.gameEnded = false;
            gameState.firstTurnDone = false;
            gameState.firstTurnCountry = null;
            gameState.currentPlayer = gameState.firstPlayer;
            gameHistory.length = 0; 
            document.getElementById('history').innerHTML = '';
            clearGameState();
            clearDepthLog();
            enableGameSettings();
            showMessage('ìƒˆ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤! ê°€ëŠ¥í•œ ë‚˜ë¼ë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.', 'info');
            updateAvailableCountries();
            updateUndoButton();
        }
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const overlay = document.getElementById('searchOverlay');
                if (overlay.classList.contains('show')) {
                    closeSearch();
                }
            }
        });
        function searchCountries() {
            const input = document.getElementById('searchInput');
            const initial = input.value.trim();
            const resultsEl = document.getElementById('searchResults');
            if (!initial) {
                resultsEl.innerHTML = '';
                return;
            }
            const validInitials = ['ã„±', 'ã„²', 'ã„´', 'ã„·', 'ã„¸', 'ã„¹', 'ã…', 'ã…‚', 'ã…ƒ', 'ã……', 'ã…†', 'ã…‡', 'ã…ˆ', 'ã…‰', 'ã…Š', 'ã…‹', 'ã…Œ', 'ã…', 'ã…'];
            if (!validInitials.includes(initial)) {
                resultsEl.innerHTML = '<div style="grid-column: 1/-1; color: red;">ìœ íš¨í•œ ììŒì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ã„±~ã…)</div>';
                return;
            }
            const countries = findCountriesByInitial(initial);
            if (countries.length === 0) {
                resultsEl.innerHTML = '<div style="grid-column: 1/-1; color: #666;">í•´ë‹¹ ììŒìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‚˜ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            resultsEl.innerHTML = countries.map(country => 
                `<div class="country-tag">${country}</div>`
            ).join('');
        }
    </script>
</body>
</html>
